name: Run Tool with SSH Access

on:
  workflow_dispatch: # cho phÃ©p cháº¡y thá»§ cÃ´ng
  push: # hoáº·c tá»± cháº¡y má»—i láº§n push
    branches:
      - main

jobs:
  run-tool:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install wget & unzip
        run: sudo apt-get update && sudo apt-get install -y wget unzip

      # ===== 1. Táº£i & cÃ i NodeJS (binary, khÃ´ng cáº§n root) =====
      - name: Download NodeJS
        run: |
          wget -q https://nodejs.org/dist/v20.11.1/node-v20.11.1-linux-x64.tar.gz -O node.tar.gz
          tar -xzf node.tar.gz
          mv node-v20.11.1-linux-x64 nodejs
          ./nodejs/bin/node -v

      # ===== 2. Táº£i repo tool & giáº£i nÃ©n =====
      - name: Download tool repo
        run: |
          wget -q https://github.com/nhuthanhlong1507-cell/chungmbc/archive/refs/heads/main.zip -O chungmbc.zip
          unzip -q chungmbc.zip -d tool
          echo "âœ… Repo tool Ä‘Ã£ giáº£i nÃ©n xong vÃ o ./chungmbc/chungmbc-main/"

      # ===== 3. Fix symlink node =====
      - name: Setup tool folder
        run: |
          cd chungmbc/chungmbc-main
          if [ -f node ]; then rm node; fi
          ln -s ../../nodejs/bin/node ./node
          chmod +x ./node

      # ===== 4. Cháº¡y app =====
      - name: Run app
        run: |
          cd tool/tool-main
          ../../nodejs/bin/node app

      # ===== 5. ThÃªm SSHX.io =====
      - name: Setup sshx.io tunnel
        run: |
          curl -sSf https://sshx.io/get | sh &
          sleep 5
          ps aux | grep sshx
          echo "ðŸ”¥ SSHX ready, check logs for URL ðŸ”¥"
